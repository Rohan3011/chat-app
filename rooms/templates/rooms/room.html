{% extends 'rooms/rooms.html' %}

{% block title %}  | {{room.name}}{% endblock title %}


{% block header %}{{room.name }}{% endblock header %}
{% block room %}
<div class="w-full lg:w-2/4">
  <div class=" m-4 p-4 rounded-lg shadow-lg space-y-4 " id="chat-messages">

    <div class="p-4 bg-gray-200 rounded-xl">
      <p class="font-semibold">Username</p>
      <p>Lorem adipisicing elit. Quidem, explicabo?</p>
    </div>

    <div class="p-4 bg-gray-200 rounded-xl">
      <p class="font-semibold">Username</p>
      <p>Lorem adipisicing elit. Quidem, explicabo?</p>
    </div>

    <div class="p-4 bg-gray-200 rounded-xl">
      <p class="font-semibold">Username</p>
      <p>Lorem adipisicing elit. Quidem, explicabo?</p>
    </div>
  </div>

  
  <div class="m-4 p-4 rounded-lg shadow-lg mt-10" id="chat-messages">
   <form method="post" action="." class="flex">
     {% csrf_token %}
     <input type="text" id="content" placeholder="Your message..." class="focus:outline-none focus:border-sky-500 focus:ring-none block w-full rounded-md focus:ring-none 
     flex grow mx-2 rounded-lg">

     <button type="submit" id="send-message" class="px-6 py-2 m-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600" >
       send
     </button>
   </form>
  </div>
</div>

{% endblock room %}


{% block scripts %}

  {{room.slug | json_script:"json-roomname"}}
  {{request.user.username | json_script:"json-username"}}


  <script>
    const roomName = JSON.parse(document.getElementById('json-roomname').textContent);
    const userName = JSON.parse(document.getElementById('json-username').textContent);
    const chatSocket = new WebSocket(
      'ws://'
      + window.location.host
      + '/ws/'
      + roomName
      + '/'
    );

    chatSocket.onmessage = function(e){
      console.log('onmessage')
      const data = JSON.parse(e.data)
      if (data)
    }

    chatSocket.onclose = function(e){
      console.log('onclose')
    }

    document.querySelector('#send-message').onClick = function(e){
        const messageContent = document.querySelector('#content')
        const message = messageContent.value;

        chatSocket.send(JSON.stringify({
           "message" : message,
           "username" : userName,
           "room" : roomName
        }))

        messageContent.value = "";
    }
  </script>

{% endblock %}